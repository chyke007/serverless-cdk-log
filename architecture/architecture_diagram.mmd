graph TD
  subgraph VPC["VPC (10.0.0.0/16)"]
    
    subgraph PublicSubnet["Public Subnet"]
      ALBLogger["Public ALB (Listener: 8080)\nSecurity Group: Allows Internet -> Logger"]
      LoggerService["ECS Fargate Service: Logger App\nTask Definition: logger-task"]
      ECRLogger["Amazon ECR: Logger Image\n(ecrstack-logger-repo)"]
      ALBLogger -->|Target Group| LoggerService
    end

    subgraph PrivateSubnet["Private Subnet"]
      ALBGrafana["Private ALB (Listener: 3000)\nSecurity Group: Internal Access"]
      ALBLoki["Private ALB (Listener: 3100)\nSecurity Group: Internal Access"]
      GrafanaService["ECS Fargate Service: Grafana\nTask Definition: grafana-task"]
      LokiService["ECS Fargate Service: Loki\nTask Definition: loki-task"]
      ECRGrafana["Amazon ECR: Grafana Image\n(ecrstack-grafana-repo)"]
      ECRLoki["Amazon ECR: Loki Image\n(ecrstack-loki-repo)"]
      EFS["Amazon EFS (Persistent Storage)\nAccess Points for Grafana & Loki"]
      S3["Amazon S3 (Log Archive Bucket)\nserverless-log-bucket-cdk"]
      
      ALBGrafana -->|Target Group| GrafanaService
      ALBLoki -->|Target Group| LokiService
      GrafanaService -- Mount --> EFS
      LokiService -- Mount --> EFS
      LokiService -- Push WAL & Chunks --> S3
    end

    subgraph Route53["Route 53 Private Hosted Zone\n(internal.com)"]
      DNSGrafana["grafana.internal.com -> Private ALB"]
      DNSLoki["loki.internal.com -> Private ALB"]
      DNSGrafana --> ALBGrafana
      DNSLoki --> ALBLoki
    end

    subgraph ClientVPN["AWS Client VPN"]
      VPNEndpoint["Client VPN Endpoint\n(Mutual TLS Auth)\nSecurity Group: Allows DNS & ALB Access"]
      VPNEndpoint --> DNSGrafana
      VPNEndpoint --> DNSLoki
    end

    LoggerService -- Logs via FireLens --> LokiService
    GrafanaService -- Queries Metrics --> LokiService
    LoggerService -- Container Images --> ECRLogger
    GrafanaService -- Container Images --> ECRGrafana
    LokiService -- Container Images --> ECRLoki
  end

  note1["Note: Logger Service is public via ALB.\nGrafana & Loki are private and accessed via Client VPN."]
